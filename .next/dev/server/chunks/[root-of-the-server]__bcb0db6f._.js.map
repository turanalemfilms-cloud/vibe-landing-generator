{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/gulzhanserikbay/vibe-landing-generator/src/lib/supabase.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js'\n\nexport function supabaseBrowser() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL\n  const anon = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY\n  if (!url || !anon) throw new Error('Missing NEXT_PUBLIC_SUPABASE_URL / NEXT_PUBLIC_SUPABASE_ANON_KEY')\n  return createClient(url, anon)\n}\n\nexport function supabaseServer() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL\n  const service = process.env.SUPABASE_SERVICE_ROLE_KEY\n  const anon = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY\n\n  if (!url) throw new Error('Missing NEXT_PUBLIC_SUPABASE_URL')\n\n  // Prefer service role for server-side writes. Fallback to anon for quick demo.\n  const key = service || anon\n  if (!key) throw new Error('Missing SUPABASE_SERVICE_ROLE_KEY or NEXT_PUBLIC_SUPABASE_ANON_KEY')\n\n  return createClient(url, key, {\n    auth: { persistSession: false },\n  })\n}\n\nexport function supabaseService() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL\n  const service = process.env.SUPABASE_SERVICE_ROLE_KEY\n  if (!url || !service) throw new Error('Missing NEXT_PUBLIC_SUPABASE_URL / SUPABASE_SERVICE_ROLE_KEY')\n  return createClient(url, service, { auth: { persistSession: false } })\n}\n\nexport function supabaseServerWithAccessToken(accessToken: string) {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL\n  const anon = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY\n  if (!url || !anon) throw new Error('Missing NEXT_PUBLIC_SUPABASE_URL / NEXT_PUBLIC_SUPABASE_ANON_KEY')\n  if (!accessToken) throw new Error('Missing access token')\n\n  // Use anon key + user JWT so RLS applies server-side.\n  return createClient(url, anon, {\n    auth: { persistSession: false },\n    global: {\n      headers: {\n        Authorization: `Bearer ${accessToken}`,\n      },\n    },\n  })\n}\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;AAEO,SAAS;IACd,MAAM;IACN,MAAM;IACN;;IACA,OAAO,IAAA,gMAAY,EAAC,KAAK;AAC3B;AAEO,SAAS;IACd,MAAM;IACN,MAAM,UAAU,QAAQ,GAAG,CAAC,yBAAyB;IACrD,MAAM;IAEN;;IAEA,+EAA+E;IAC/E,MAAM,MAAM,WAAW;IACvB;;IAEA,OAAO,IAAA,gMAAY,EAAC,KAAK,KAAK;QAC5B,MAAM;YAAE,gBAAgB;QAAM;IAChC;AACF;AAEO,SAAS;IACd,MAAM;IACN,MAAM,UAAU,QAAQ,GAAG,CAAC,yBAAyB;IACrD,IAAI,CAAC,OAAO,CAAC,SAAS,MAAM,IAAI,MAAM;IACtC,OAAO,IAAA,gMAAY,EAAC,KAAK,SAAS;QAAE,MAAM;YAAE,gBAAgB;QAAM;IAAE;AACtE;AAEO,SAAS,8BAA8B,WAAmB;IAC/D,MAAM;IACN,MAAM;IACN;;IACA,IAAI,CAAC,aAAa,MAAM,IAAI,MAAM;IAElC,sDAAsD;IACtD,OAAO,IAAA,gMAAY,EAAC,KAAK,MAAM;QAC7B,MAAM;YAAE,gBAAgB;QAAM;QAC9B,QAAQ;YACN,SAAS;gBACP,eAAe,CAAC,OAAO,EAAE,aAAa;YACxC;QACF;IACF;AACF"}},
    {"offset": {"line": 113, "column": 0}, "map": {"version":3,"sources":["file:///Users/gulzhanserikbay/vibe-landing-generator/src/lib/rateLimit.ts"],"sourcesContent":["type Bucket = { count: number; resetAt: number }\n\nconst buckets = new Map<string, Bucket>()\n\nexport function rateLimit(key: string, limit: number, windowMs: number) {\n  const now = Date.now()\n  const b = buckets.get(key)\n  if (!b || b.resetAt <= now) {\n    buckets.set(key, { count: 1, resetAt: now + windowMs })\n    return { ok: true, remaining: limit - 1, resetAt: now + windowMs }\n  }\n  if (b.count >= limit) {\n    return { ok: false, remaining: 0, resetAt: b.resetAt }\n  }\n  b.count += 1\n  return { ok: true, remaining: limit - b.count, resetAt: b.resetAt }\n}\n\n"],"names":[],"mappings":";;;;AAEA,MAAM,UAAU,IAAI;AAEb,SAAS,UAAU,GAAW,EAAE,KAAa,EAAE,QAAgB;IACpE,MAAM,MAAM,KAAK,GAAG;IACpB,MAAM,IAAI,QAAQ,GAAG,CAAC;IACtB,IAAI,CAAC,KAAK,EAAE,OAAO,IAAI,KAAK;QAC1B,QAAQ,GAAG,CAAC,KAAK;YAAE,OAAO;YAAG,SAAS,MAAM;QAAS;QACrD,OAAO;YAAE,IAAI;YAAM,WAAW,QAAQ;YAAG,SAAS,MAAM;QAAS;IACnE;IACA,IAAI,EAAE,KAAK,IAAI,OAAO;QACpB,OAAO;YAAE,IAAI;YAAO,WAAW;YAAG,SAAS,EAAE,OAAO;QAAC;IACvD;IACA,EAAE,KAAK,IAAI;IACX,OAAO;QAAE,IAAI;QAAM,WAAW,QAAQ,EAAE,KAAK;QAAE,SAAS,EAAE,OAAO;IAAC;AACpE"}},
    {"offset": {"line": 152, "column": 0}, "map": {"version":3,"sources":["file:///Users/gulzhanserikbay/vibe-landing-generator/src/app/api/screenshot/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\nimport puppeteer from 'puppeteer'\nimport { supabaseServer } from '@/lib/supabase'\nimport { rateLimit } from '@/lib/rateLimit'\n\ntype ScreenshotRequest = {\n  siteId: string\n  view?: 'desktop' | 'mobile'\n  kind?: 'legacy_site' | 'revision'\n}\n\nexport const runtime = 'nodejs'\n\nexport async function POST(req: Request) {\n  {\n    const ip =\n      req.headers.get('x-forwarded-for')?.split(',')[0]?.trim() ||\n      req.headers.get('x-real-ip') ||\n      'unknown'\n    const r = rateLimit(`shot:${ip}`, 10, 60_000)\n    if (!r.ok) {\n      return NextResponse.json({ error: 'Rate limit. Try again in a minute.' }, { status: 429 })\n    }\n  }\n  let body: ScreenshotRequest\n  try {\n    body = (await req.json()) as ScreenshotRequest\n  } catch {\n    return NextResponse.json({ error: 'Invalid JSON body' }, { status: 400 })\n  }\n\n  if (!body?.siteId) {\n    return NextResponse.json({ error: 'siteId is required' }, { status: 400 })\n  }\n\n  const view = body.view || 'desktop'\n  const origin = req.headers.get('origin')\n  const baseUrl =\n    process.env.NEXT_PUBLIC_SITE_URL ||\n    (process.env.VERCEL_URL ? `https://${process.env.VERCEL_URL}` : origin) ||\n    'http://localhost:3000'\n  const targetUrl = `${baseUrl}/site/${body.siteId}`\n\n  const viewport =\n    view === 'mobile'\n      ? { width: 390, height: 844, deviceScaleFactor: 2, isMobile: true }\n      : { width: 1440, height: 900, deviceScaleFactor: 2 }\n\n  let browser: puppeteer.Browser | null = null\n  try {\n    browser = await puppeteer.launch({\n      headless: 'new',\n      args: ['--no-sandbox', '--disable-setuid-sandbox'],\n    })\n\n    const page = await browser.newPage()\n    await page.setViewport(viewport as any)\n    await page.goto(targetUrl, { waitUntil: 'networkidle2', timeout: 60000 })\n    await page.waitForTimeout(500)\n\n    const buffer = await page.screenshot({ fullPage: true, type: 'png' })\n\n    const supabase = supabaseServer()\n    const path = `${body.siteId}/${view}.png`\n\n    const upload = await supabase.storage\n      .from('site-screens')\n      .upload(path, buffer, { contentType: 'image/png', upsert: true })\n\n    if (upload.error) {\n      return NextResponse.json({ error: 'Upload failed', details: upload.error.message }, { status: 500 })\n    }\n\n    const publicUrl = supabase.storage.from('site-screens').getPublicUrl(path).data.publicUrl\n\n    const update = await supabase\n      .from(body.kind === 'legacy_site' ? 'sites' : 'revisions')\n      .update(\n        view === 'mobile'\n          ? { screenshot_mobile_path: path }\n          : { screenshot_desktop_path: path }\n      )\n      .eq('id', body.siteId)\n\n    if (update.error) {\n      return NextResponse.json({ error: 'DB update failed', details: update.error.message }, { status: 500 })\n    }\n\n    return NextResponse.json({ ok: true, path, publicUrl })\n  } catch (e) {\n    return NextResponse.json({ error: 'Screenshot failed', details: String((e as any)?.message || e) }, { status: 500 })\n  } finally {\n    if (browser) await browser.close()\n  }\n}\n"],"names":[],"mappings":"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"}}]
}